-- Criação de uma trigger funcion de log para quando um médico responsável é atribuído a um paciente (1)//-1 trigger -1 funcao
CREATE OR REPLACE FUNCTION novomedico()
RETURNS trigger AS
$BODY$ BEGIN
INSERT INTO Log (tabela,dt_log,Atividade) Values ('Paciente',now(),CONCAT(
(select nome from pessoa where id_pessoa=(select id_pessoa from medico where id_medico=new.ID_Medico))
,' foi adicionado como novo medico no lugar do ',
(select nome from pessoa where id_pessoa=(select id_pessoa from medico where id_medico=old.id_medico)))); 

	RETURN NULL;

END;
$BODY$ LANGUAGE 'plpgsql';

CREATE TRIGGER updatemedico
after UPDATE of id_medico on paciente
FOR EACH ROW
EXECUTE PROCEDURE novomedico();

--

-- trigger fuction para deletar a linha de quem ja foi atendido //-1 trigger -1 funcao

CREATE OR REPLACE FUNCTION deletalinha()
RETURNS trigger AS
$BODY$ BEGIN
delete from prioridade where bl_atendimento = 't';

	RETURN NULL;

END;
$BODY$ LANGUAGE 'plpgsql';

CREATE TRIGGER atendido
after update of bl_atendimento on prioridade
for each row
EXECUTE PROCEDURE deletalinha();

--

-- Desenvolvimento de um procedimento para verificar há quanto tempo o paciente esta na fila (0.5) //-1 funcao (+1(3 funcoes))
CREATE OR REPLACE FUNCTION tempoespera(fila integer)
RETURNS varchar(20) AS
$BODY$ BEGIN

	RETURN (select now()-(select tm_prioridade from prioridade where sn_fila=fila));

END;
$BODY$ LANGUAGE 'plpgsql';
--






















